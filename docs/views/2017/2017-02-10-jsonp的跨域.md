## jsonp跨域
> jsonp和ajax相同, 都是客户端向服务器发送请求, 给服务器发送请求传递数据, 然后同服务器获取数据
> jsonp和ajax比较
- ajax属于同源策略
- jsonp属于非同源策略(跨域请求)
> 当前页面的url地址(webstorm在预览页面的时候会默认的创建一个本地虚拟的服务, 端口号是63342)

http://localhost:63342/备课node/1.node基础/1.html

http://localhost:63342/备课node/node/1.node基础/data.txt

> 练习: 通过ajax请求
- 当前路径下的data.json文件内容
- 通过ajax请求百度https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su?wd=a
- 通过ajax请求腾讯http://matchweb.sports.qq.com/kbs/calendar?columnId=100000
- 找出每个请求的url地址和当前html文件的url地址进行比较
```
var xhr = new XMLHttpRequest();
    //ajax支持同源请求
    //xhr.open('get', 'http://localhost:63342/%E5%A4%87%E8%AF%BE/node/1.%20node%E5%9F%BA%E7%A1%80/data.txt', true);
    //ajax不支持非同源请求->XMLHttpRequest cannot load https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su?wd=a. No 'Access-Control-Allow-Origin' header is present on the requested resource. Origin 'http://localhost:63342' is therefore not allowed access.
   // xhr.open('get', 'https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su?wd=a', true);
    xhr.open('get', 'http://matchweb.sports.qq.com/kbs/calendar?columnId=100000', true);
    xhr.onreadystatechange = function () {
        if (xhr.readyState == 4 && /^2\d{2}$/.test(xhr.status)){
            console.log(xhr.responseText);
        }
    };
    xhr.send(null);
```

> 同源和非同源需要比较的内容: 三者必须完全相同才能算同源
- 协议名
- 域名
- 端口号

### jsonp的原理
> jsonp实现跨域请求是通过script标签, 不受非同源的影响, 通过script的src获取非同源url下的信息
> jsonp实现跨域请求的步骤
- 1: 我们首先把需要请求的数据url地址, 赋值给script标签的src属性
- 2: 把当前页面中的某一个函数名通过url传参的方式添加到url中传递给服务器进行请求->例如: url?callback=fn
- 3: 服务器接收到客户端的请求后, 需要进行特殊的处理, 把你传递进来的函数名和它需要传递给你的数据拼接成一个字符串, 返回给客户端(例如: 客户端传递的函数名为fn, 返回的数据就放在fn函数中作为实参进行传递, 'fn(数据)');
- 4: 最后服务器把准备好的数据通过http协议返回给客户端, 返回的内容其实就是fn方法的调用, 传递的数据就是fn方法的实参

> jsonp跨域请求腾讯看比赛客户端
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>jsonp跨域请求</title>
</head>
<body>

</body>
<script>
    function fn(data){ //fn中data就是服务器传递给客户端的数据
        console.log(data);
    }
</script>
<!--通过script标签实现跨域请求, 将当前html文件中的fn方法名, 通过url传给服务器, 服务器返回的就是fn方法的调用-->
<script src="http://matchweb.sports.qq.com/kbs/calendar?columnId=100000&callback=fn"></script>
</html>
```

> jsonp跨域请求自定义服务端
- 练习: 实现静态资源文件的请求
> 服务端
```js
var http = require('http');
var url = require('url');
var fs = require('fs');
//创建服务
var server = http.createServer(function (req, res) {
    var urlObj = url.parse(req.url, true); //解析url
    var pathname = urlObj.pathname; //请求路径
    var query = urlObj.query; //请求参数

    var reg = /\.(HTML|CSS|JS|TXT|JSON|ICO)/i;
    //静态资源文件处理
    if (reg.test(pathname)){ //如果请求的文件包含正则中的内容
        var suffix = reg.exec(pathname)[1].toUpperCase();//获取请求文件的后缀名, 转换成大写
        var suffixMIME = 'text/html';//默认是html文件

        switch (suffix){ //通过检索的pathname的后缀名, 获取对应的MIME类型
            case 'HTML': {
                suffixMIME = 'text/HTML';
            } break;
            case 'CSS': {
                suffixMIME = 'text/css';
            } break;
            case 'JS': {
                suffixMIME = 'text/application';
            } break;
            case 'JSON': {
                suffixMIME = 'application/json';
            } break;
            case 'TXT': {
                suffixMIME = 'text/plain';
            } break;
        }

        //如果请求的是/index.html文件
        try {
            var con = fs.readFileSync('.' + pathname, 'utf8');  //读取index.html内容
            res.writeHead(200, {'content-type':suffixMIME+';charset=utf8'});
            res.end(con);//返回信息给客户端
        }catch (err){
            res.writeHead(404, {'content-type': "text/plain;charset=utf8"});
            res.end('request file is not find');//返回信息给客户端
        }
    }

    //jsonp请求处理
    if (pathname == '/getAll'){
        var callback = query['callback'];//获取url中的回调函数方法名
        //准备数据存放在json文件中独处
        var conFile = fs.readFileSync('./custom.json', 'utf8');
        //返回给客户端
        res.writeHead(200, {'content-type':'text/javascript;charset=utf8'}); //按照js代码解析返回的内容, 执行返回的回调函数, 将内容作为实参进行传递
        res.end(callback+'('+conFile+')');//方法名(数据)

    }
});

//监听端口
server.listen(8080, function () {
    console.log('server is success, listening 8080...');
});
```
> 客户端
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ajax四步</title>
</head>
<body>

</body>
<script>
    //2: 创建一个自定义函数
    function fn(data) {
        //4，5：等待服务器返回数据
        console.log(data);
    }
</script>
<!--1: 将非同源的url地址赋值给script标签的src属性-->
<!--3: 将自定义函数名拼接到url末尾-->
<script src="http://localhost:8080/getAll?callback=fn"></script>
```

### jquery中的ajax
```htm
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>jquery中的jsonp</title>
</head>
<body>

</body>
<script src="./public/jquery.js"></script>
<script>
    /**
     * jquery中的ajax
     * jquery中的ajax方法是定义在jquery自身的一个方法，直接使用$调用即可
     * 参数：ajax请求的相关配置
     * */
    $.ajax({
        type: 'get', //请求类型
        url: 'data.txt',  //请求url地址
        async: true,     //是否同步
        data: null,   //客户端通过请求体传递的数据
        cache: false, //是否需要缓存(url末尾增加?_随机数), 默认有缓存
        dataType: 'json',//请求数据转换成json对象
        timeout: 3000, //超时时间设置，超过该时间后数据没有请求回来，调用error回调
        success: function (data) { //请求成功时候的回调，参数data是请求回来的数据
            console.log(data); //请求回来的数据默认是string类型
        },
        error: function (err) {//请求数据失败时候的回调
            console.log(err);
        }
    });

</script>
</html>
```

### jquery中的jsonp跨域请求
> 跨域请求地址: http://matchweb.sports.qq.com/kbs/calendar?columnId=100000
> jquery转换后地址： http://matchweb.sports.qq.com/kbs/calendar?columnId=100000&callback=jQuery31106322290808849953_1477278795125&_=1477278795126 自动在末尾追加callback方法名， 是一个jQuery随机数, 自动追加随机数清除缓存, jsonp都是get请求

> jsonp简单用法
```js
/**
     * jquery中的ajax
     * jquery中的ajax方法是定义在jquery自身的一个方法，直接使用$调用即可
     * 参数：ajax请求的相关配置
     * */
    $.ajax({
        url: 'http://matchweb.sports.qq.com/kbs/calendar?columnId=100000',  //请求url地址
        dataType: 'jsonp',//jsonp跨域请求
        success: function (data) { //请求成功时候的回调，参数data是请求回来的数据
            console.log(data); //请求回来的数据默认是string类型
        }
    });
```
> 修改回调函数名和回调函数属性名(jsonpCallback和jsonp)
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>jquery中的jsonp</title>
</head>
<body>

</body>
<script src="./public/jquery.js"></script>
<script>
    /**
     * jquery中的ajax
     * jquery中的ajax方法是定义在jquery自身的一个方法，直接使用$调用即可
     * 参数：ajax请求的相关配置
     * */
    $.ajax({
        url: 'http://matchweb.sports.qq.com/kbs/calendar?columnId=100000',  //请求url地址
        dataType: 'jsonp',//jsonp跨域请求
        jsonpCallback: 'fn',//指定回调函数的方法名， 不使用jquery自动指定(callback='fn')
        jsonp:'cb',//改变回调函数的方法名, 将callback变成cb(cb=fn)
        success: function (data) { //请求成功时候的回调，参数data是请求回来的数据
            console.log(data); //请求回来的数据默认是string类型
        }
    });

</script>
</html>
```

### jquery中的jsonp跨域请求实战(百度下拉搜索)
> 百度搜索接口： https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su?wd=a&cb=jQuery110205029368403378756_1477280723821&_=1477280723824
> 回调函数属性名：jsonp: 'cb'
```html
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>baidu</title>
    <style>
        *{
            margin: 0;
            padding: 0;
        }
        html, body{
            width: 100%;
            height: 100%;
            overflow: hidden;
            font-size: 14px;
            color: #000;
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
        }
        ul, li{
            list-style: none;
        }
        input{
            outline: none;
        }
        .box{
            width: 300px;
            margin: 50px auto;
        }
        .box input{
            width: 280px;
            height: 30px;
            padding: 0 10px;
            border: 1px solid lightgreen;
        }
        .box ul{
            width: 100%;
            border: 1px solid lightgreen;
            border-top: none;
        }
        .box ul li{
            padding: 0 10px;
            height: 25px;
            line-height: 25px;
        }
    </style>
</head>
<body>
    <div class="box">
        <input type="text" id="searchInp">
        <ul id="searchList">
        </ul>
    </div>
</body>
<script src="public/jquery.js"></script>
<script>
    var searchModule = (function () {
        var $searchInp = $('#searchInp');
        var $searchList = $('#searchList');

        function bindHTML(){
            var wd = $searchInp.val(); //获取搜索框中的内容
            $.ajax({
                url:'https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su?wd='+wd,
                dataType: 'jsonp',
                jsonp: 'cb',
                success: function (data) {
                    var str = '';
                    $.each(data.s, function (index, item) { //遍历数据源
                        if (index<=3){  //取前四条
                            str += '<li>'+item+'</li>'; //绑定数据
                        }
                    });
                    //设置结果列表
                    $searchList.html(str).stop().slideDown(100);
                }
            });
        }
        //向百度服务器发送jsonp请求，把请求回来的数据绑定在页面上
        function init(){
            $searchInp.on('keyup focus', function () {
                var val = $(this).val();
                if (val.length > 0){
                    bindHTML();
                    return;
                }
                $searchList.stop().slideUp(100);
            });

            //当点击展示框中的li的时候，把li的内容显示到搜索框中，并且把搜索列表隐藏
            $searchList.on('click', function (ev) {
                var tar = ev.target;
                var tarTag = tar.tagName.toUpperCase();
                var $tar = $(tar);
                if (tarTag == 'LI'){
                    $searchInp.val($tar.html());
                    $searchList.stop().slideUp(100);
                }
            })
        }

        return {
            init: init
        }
    })();
    searchModule.init();
</script>
</html>
```